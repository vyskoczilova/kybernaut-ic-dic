# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

**Kybernaut IC DIC** is a WordPress/WooCommerce plugin that adds Czech and Slovak company identification fields (Business ID, Tax ID, VAT registration number) to WooCommerce checkout forms. It validates these numbers against official registries (ARES for Czech Republic, VIES for EU VAT) and supports automatic VAT exemption for valid intra-EU B2B transactions.

- **Main plugin file**: `woolab-ic-dic.php`
- **PHP compatibility**: 7.3+
- **WooCommerce compatibility**: 3.5.0+ (HPOS compatible)

## Build and Development Commands

### Building assets
```bash
# Install dependencies
npm install

# Build all assets (CSS, JS, translations)
gulp build

# Individual tasks
gulp styles    # Minify CSS from src/css/ to assets/css/
gulp scripts   # Transpile and minify JS from src/js/ to assets/js/
gulp translate # Generate .pot translation file
```

### Running tests
```bash
# Install PHP dependencies for testing
composer install

# Run unit tests
composer test:unit
# or directly:
vendor/bin/phpunit --testsuite Unit
```

The test suite uses WP_Mock (10up/wp_mock) for mocking WordPress functions without requiring a full WordPress installation.

## Architecture

### Code Organization

**PHP Structure:**
- `woolab-ic-dic.php` - Main plugin file with initialization, hooks registration, and core helper functions
- `includes/` - Core functionality organized by responsibility:
  - `filters-actions.php` - Main business logic for checkout fields, validation, and order processing
  - `ares.php` - Czech ARES registry API integration for Business ID verification
  - `helpers.php` - Mathematical validation functions for IC/DIC/RC numbers
  - `settings.php` - WooCommerce settings integration
  - `logger.php` - Custom logging implementation
  - `admin-notice.php` - Admin notifications
  - `compatibility/` - Third-party plugin compatibility layers (SuperFaktura, PDF Invoices, Fluid Checkout)

**Frontend Assets:**
- `src/` - Source files (unminified)
  - `js/public.js` - Checkout AJAX for ARES autofill
  - `js/admin.js` - Admin settings page scripts
  - `js/admin-edit.js` - Order edit page scripts
  - `css/` - Styles for toggle functionality and admin UI
- `assets/` - Built/minified files (generated by gulp)

**Dependencies:**
- Uses `wpify/scoper` to namespace third-party dependencies (prefix: `KybernautIcDicDeps`)
- Scoped dependencies are in `deps/` directory
- Main dependency: `ibericode/vat` for VIES validation

### Key Architectural Patterns

**Field Registration Flow:**
1. Fields added via `woocommerce_billing_fields` and `woocommerce_checkout_fields` filters
2. Validation happens in `woolab_icdic_checkout_field_process` action on `woocommerce_checkout_process`
3. Fields are saved to order meta automatically by WooCommerce
4. Custom fields displayed via `woocommerce_admin_billing_fields` filter

**Validation Strategy:**
- **Czech IC (Business ID)**: Mathematical validation via `woolab_icdic_verify_ic()` + optional ARES check
- **Czech DIC (Tax ID)**: Can be either RC (birth number) or IC-based, validated mathematically
- **Slovak IC**: Mathematical validation only (8-digit modulo-11 check)
- **Slovak DIC**: Required when IC is present, mathematical validation
- **Slovak DIC DPH (VAT)**: EU VIES validation, must match DIC with SK prefix
- **EU VAT numbers**: VIES validation via `ibericode/vat` library

**ARES Integration:**
- New REST API endpoint (since 2024): `https://ares.gov.cz/ekonomicke-subjekty-v-be/rest/ekonomicke-subjekty/{ico}`
- Used for both validation and autofill functionality
- AJAX endpoint: `ajaxAres` (both logged-in and guest users)
- Graceful degradation: if ARES fails and `woolab_icdic_ignore_check_fail` is enabled, order proceeds with warning

**VAT Exemption Logic:**
- Automatically sets `WC_Customer->set_is_vat_exempt()` for valid intra-EU B2B transactions
- Only applies when:
  - Base country differs from billing country
  - Both countries are in EU VAT area
  - Valid VAT number verified via VIES
- Controlled by `woolab_icdic_vat_exempt_switch` setting

**HPOS Compatibility:**
- Plugin declares compatibility via `FeaturesUtil::declare_compatibility()`
- Different hooks for legacy vs HPOS: `manage_shop_order_posts_custom_column` vs `woocommerce_shop_order_list_table_custom_column`
- Order retrieval works with both CPT and HPOS via `wc_get_order()`

### Country-Specific Behavior

**Czech Republic (CZ):**
- IC (Business ID): 8 digits, validated against ARES
- DIC (Tax ID): CZ + (IC or RC), optional
- ARES autofill can populate company name, address, postcode, city

**Slovakia (SK):**
- IC (Business ID): 8 digits, mathematical validation
- DIC (Tax ID): 10 digits, required when IC is present (not a VAT number)
- DIC DPH (VAT registration): SK prefix + 10 digits, optional, validated via VIES
- Special validation: DIC DPH must match DIC with SK prefix

**Other EU Countries:**
- Only DIC field shown (relabeled as VAT number)
- Validated via VIES

### Important Filters for Customization

- `woolab_icdic_class_{field_name}` - Modify field CSS classes
- `woolab_icdic_ares_check` - Enable/disable ARES validation
- `woolab_icdic_ares_fill` - Enable/disable ARES autofill
- `woolab_icdic_vies_check` - Enable/disable VIES validation
- `woolab_icdic_ignore_check_fail` - Allow orders even if validation fails
- `woolab_icdic_vat_exempt_enabled` - Control VAT exemption feature
- `woolab_icdic_base_country` - Override base country for VAT exemption logic
- `woolab_icdic_sk_required_ic_and_dic` - Require both IC and DIC in Slovakia
- `woolab_icdic_update_user_meta` - Update user profile when editing orders

### Known Limitations

- Cart/Checkout blocks not supported (only shortcode-based checkout)
- VIES validation requires PHP `SoapClient` extension
- Fluid Checkout compatibility exists but not loaded globally (must be manually included)

## Common Development Patterns

### Adding a new validation function
Validation helpers go in `includes/helpers.php`. Follow the pattern of existing functions like `woolab_icdic_verify_ic()` - return boolean, accept clean input (no whitespace).

### Modifying ARES response parsing
The ARES API structure is defined in `includes/ares.php`. The API returns JSON with structure:
- `obchodniJmeno` - company name
- `ico` - business ID
- `dic` - tax ID
- `sidlo` object with address components

### Testing checkout validation
Tests go in `tests/unit/`. Use WP_Mock to mock WordPress functions. See `tests/unit/AresTest.php` for examples.

### Scoping dependencies
Dependencies are scoped using wpify/scoper to avoid conflicts. Configuration in composer.json:
```json
"extra": {
    "wpify-scoper": {
        "prefix": "KybernautIcDicDeps"
    }
}
```

After adding dependencies, run composer-scoper workflow to generate scoped versions in `deps/`.
